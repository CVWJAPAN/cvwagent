<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline';">
    <title>Global Kids Support Hub</title>
    <style>
        body{font-family:Arial,sans-serif;background:#fff5f5;margin:0;padding:20px;text-align:center}
        #welcome-screen,#hub-container{max-width:600px;margin:0 auto;background:#fff;padding:20px;border-radius:15px;box-shadow:0 2px 10px rgba(0,0,0,0.1);text-align:left}
        #hub-container{display:none}
        h1{color:#c71585;font-size:24px;margin-bottom:10px}
        h2{color:#c71585;font-size:18px;margin-top:20px;border-bottom:1px solid #ffe4e1;padding-bottom:5px}
        h3{color:#ff69b4;font-size:16px;margin-top:10px}
        p,li{font-size:14px;color:#333;line-height:1.5}
        .button{background:#ff69b4;color:#fff;padding:10px 20px;border:none;border-radius:10px;cursor:pointer;font-size:14px;margin:10px 0}
        .button:hover{background:#ff4f9a}
        #chat-box,#place-list,#donation-report,#verification-status,#support-request,#support-reservation,#donation-counter{border:1px solid #e0e0e0;border-radius:10px;padding:15px;height:150px;overflow-y:scroll;background:#f9f9f9;margin-bottom:15px}
        .chat-message,.place-item,.donation-item,.verification-item,.request-item,.reservation-item{margin:8px 0;padding:8px;border-radius:8px;font-size:13px}
        .hub-message{background:#ffe4e1;max-width:80%;margin-left:5px}
        .user-message{background:#f5e1ff;text-align:right;max-width:80%;margin-left:auto;margin-right:5px}
        .place-item,.donation-item,.verification-item,.request-item,.reservation-item{background:#fff0f5}
        #user-input,#support-input,#support-address{width:calc(100% - 20px);padding:10px;border:1px solid #e0e0e0;border-radius:10px;font-size:14px;margin-bottom:10px}
        select{width:calc(100% - 20px);padding:8px;border:1px solid #e0e0e0;border-radius:8px;font-size:14px}
        #points{display:inline-block;background:#ffe4e1;padding:5px 10px;border-radius:10px;font-size:14px;margin-bottom:10px}
        .premium{background:#98fb98;padding:5px}
        #donation-counter span{font-size:18px;color:#c71585}
        .selected{background:#90ee90} /* 抽選で選ばれた申請のスタイル */
    </style>
</head>
<body>
    <div id="welcome-screen">
        <h1>Global Kids Support Hub</h1>
        <p>「みんなの居場所おあがり」が地方の貧困世帯を支援！地域児童センター建設を目指します。非常食および賞味期限切れの食品は配布しません。配布先が不明な場合は配布できません。</p>
        <p><strong>セキュリティ:</strong> 個人情報は暗号化通信で保護し、支援目的以外には使用しません。詳細は<a href="https://cvwjapan-1.jimdosite.com/privacy-policy" target="_blank">プライバシーポリシー</a>をご覧ください。</p>
        <button class="button" onclick="startHub()">ハブを始める</button>
    </div>
    <div id="hub-container">
        <h1>Global Kids Support Hub</h1>
        <h2>寄付状況（地域児童センター建設目標: 50,000,000円）</h2>
        <div id="donation-counter">
            <p>寄付総額: <span id="donation-total">0</span> 円 (目標: 50,000,000円)</p>
            <button class="button" onclick="addDonation(500)">500円寄付</button>
            <button class="button" onclick="addDonation(1000)">1000円寄付</button>
            <p>寄付はこちら: <a href="https://checkout.square.site/merchant/MLX30TSTRDSNB/checkout/RLEFR7MZEVMZKTKADM4TVTAS" target="_blank">Square支払いリンク</a></p>
            <p id="donation-message"></p>
        </div>
        <div id="points">ポイント残高: <span id="points-value">100</span> Supportポイント</div>
        <button class="button" onclick="upgradePremium()">プレミアム会員になる（500円/月）</button>
        <h2>Kids Helper AIに相談</h2>
        <div id="chat-box">
            <div class="chat-message hub-message">Kids Helper AI: こんにちは！「みんなの居場所おあがり」が地方の貧困世帯を支援します。地域児童センター建設を目指しています。非常食および賞味期限切れの食品は配布しません。配布には住所が必要です。個人情報は厳格に管理します。寄付はこちら: <a href="https://checkout.square.site/merchant/MLX30TSTRDSNB/checkout/RLEFR7MZEVMZKTKADM4TVTAS" target="_blank">Square支払いリンク</a></div>
        </div>
        <input type="text" id="user-input" placeholder="相談を入力..." onkeypress="if(event.key === 'Enter') sendMessage()">
        <button onclick="sendMessage()" class="button">送信</button>
        <h2>食料支援依頼（地方の貧困世帯向け、月1回抽選）</h2>
        <p><strong>注意:</strong> 毎月1日に抽選で2世帯を選択します。1世帯1回限りで、重複申請は無効となります。</p>
        <input type="text" id="support-input" placeholder="支援内容（例: 米5kg）..." onkeypress="if(event.key === 'Enter') requestSupport()">
        <select id="disability">
            <option value="none">障がいなし</option>
            <option value="sensory">感覚過敏</option>
            <option value="other">その他障がい</option>
        </select>
        <select id="allergy">
            <option value="none">アレルギーなし</option>
            <option value="egg">卵</option>
            <option value="milk">乳製品</option>
            <option value="wheat">小麦</option>
            <option value="other">その他</option>
        </select>
        <input type="text" id="allergy-detail" placeholder="具体的なアレルギー（任意）..." onkeypress="if(event.key === 'Enter') requestSupport()">
        <input type="text" id="support-address" placeholder="配布先住所（例: 〒123-4567 東京都XX区XX町）..." onkeypress="if(event.key === 'Enter') requestSupport()">
        <button class="button" onclick="requestSupport()">依頼</button>
        <div id="support-request"></div>
        <button class="button" onclick="runLottery()">抽選実行（テスト用）</button>
    </div>

    <script>
        let userPoints = 100;
        let isPremium = false;
        let userProfile = { childAge: 5, needs: ["発達"] };
        let donationTotal = 0; // 初期値を0円
        let submittedAddresses = localStorage.getItem("submittedAddresses") ? JSON.parse(localStorage.getItem("submittedAddresses")) : [];
        let currentMonthRequests = []; // 月ごとの申請リスト

        function startHub(){
            document.getElementById("welcome-screen").style.display="none";
            document.getElementById("hub-container").style.display="block";
            loadMonthlyRequests();
        }

        function sendMessage(){
            const e=document.getElementById("user-input"),t=document.getElementById("chat-box"),n=e.value.trim().toLowerCase();
            if(n){
                const s=document.createElement("div");s.className="chat-message user-message",s.innerText="あなた: "+n,t.appendChild(s);
                const a=document.createElement("div");a.className="chat-message hub-message",a.innerText="Kids Helper AI: "+getAIResponse(n),t.appendChild(a);
                if(n.includes("ボランティア")){
                    userPoints += 10;
                    document.getElementById("points-value").innerText = userPoints;
                    const reward=document.createElement("div");reward.className="chat-message hub-message";
                    reward.innerText="Kids Helper AI: ボランティア参加ありがとう！10ポイント獲得！";t.appendChild(reward);
                }
                e.value="",t.scrollTop=t.scrollHeight;
            }
        }

        function getAIResponse(e){
            if(e.includes("貧困")){
                return "「みんなの居場所おあがり」は地方の貧困世帯向けに食料支援を提供します。地域児童センター建設を目指しています。毎月1日に抽選で2世帯を選択。非常食および賞味期限切れの食品は配布しません。配布には住所が必要です。個人情報は厳格に管理します。依頼は下のフォームから。寄付はこちら: <a href='https://checkout.square.site/merchant/MLX30TSTRDSNB/checkout/RLEFR7MZEVMZKTKADM4TVTAS' target='_blank'>Square支払いリンク</a>";
            }else if(e.includes("個人情報")){
                return "配布には住所が必要です。個人情報は支援目的のみに使用し、厳格に管理します。詳細は<a href='https://cvwjapan-1.jimdosite.com/privacy-policy' target='_blank'>プライバシーポリシー</a>をご覧ください。";
            }else{
                return "「みんなの居場所おあがり」では食料支援が可能です。地域児童センター建設にご協力ください。配布先住所を指定してください。"+(isPremium?"<span class='premium'>プレミアム特典: 優先予約</span>":"");
            }
        }

        function validateAddress(addr) {
            const postalCodePattern = /^\d{3}-\d{4}/;
            return postalCodePattern.test(addr.split(" ")[0]);
        }

        function requestSupport(){
            const e=document.getElementById("support-input"), d=document.getElementById("disability").value, a=document.getElementById("allergy").value, ad=document.getElementById("allergy-detail").value, addr=document.getElementById("support-address").value, t=document.getElementById("support-request"), n=e.value.trim();
            if(n && addr){
                if(!validateAddress(addr)){
                    alert("住所は「〒123-4567 東京都XX区XX町」の形式で入力してください。");
                    return;
                }
                if(submittedAddresses.includes(addr)){
                    alert("この住所は既に申請されています。");
                    return;
                }
                const item=document.createElement("div");item.className="request-item";
                const priority = d !== "none" ? "（優先対応）" : "";
                const allergyInfo = a !== "none" ? `, アレルギー: ${a} (${ad || "詳細なし"})` : "";
                item.innerText=`依頼: ${n}, 住所: ${addr}, 障がい: ${d}${priority}${allergyInfo}`;
                t.appendChild(item);
                currentMonthRequests.push({ address: addr, element: item });
                submittedAddresses.push(addr);
                localStorage.setItem("submittedAddresses", JSON.stringify(submittedAddresses));
                e.value=""; ad.value=""; addr.value="";
                t.scrollTop = t.scrollHeight;
            } else {
                alert("配布先住所を入力してください。");
            }
        }

        function loadMonthlyRequests() {
            const now = new Date();
            const currentMonth = now.getFullYear() + "-" + String(now.getMonth() + 1).padStart(2, '0');
            const storedMonth = localStorage.getItem("currentMonth");
            if (!storedMonth || storedMonth !== currentMonth) {
                currentMonthRequests = [];
                localStorage.setItem("currentMonth", currentMonth);
                const requests = document.getElementById("support-request");
                requests.innerHTML = ""; // 月初めにリセット
            }
        }

        function runLottery() {
            if (currentMonthRequests.length < 2) {
                alert("抽選には最低2件の申請が必要です。");
                return;
            }
            const winners = [];
            while (winners.length < 2 && currentMonthRequests.length > 0) {
                const index = Math.floor(Math.random() * currentMonthRequests.length);
                const winner = currentMonthRequests.splice(index, 1)[0];
                winners.push(winner);
                winner.element.className = "request-item selected";
            }
            alert("抽選結果: 2世帯が選ばれました。運営が連絡します。");
        }

        function addDonation(amount) {
            donationTotal += amount;
            document.getElementById("donation-total").innerText = donationTotal.toLocaleString(); // 3桁区切り
            const message = document.getElementById("donation-message");
            message.innerText = `${amount.toLocaleString()}円の寄付ありがとうございます！`;
            setTimeout(() => { message.innerText = ""; }, 3000); // 3秒後にメッセージ消去
            if (donationTotal >= 50000000) {
                message.innerText = "目標達成！地域児童センター建設が実現します。";
            }
        }

        function upgradePremium(){
            isPremium = true;
            alert("プレミアム会員になりました！月額500円で優先予約が可能に。Squareで支払い: <a href='https://checkout.square.site/merchant/MLX30TSTRDSNB/checkout/RLEFR7MZEVMZKTKADM4TVTAS' target='_blank'>こちら</a>");
            document.getElementById("chat-box").innerHTML += "<div class='chat-message hub-message'><span class='premium'>プレミアム特典: 優先予約が有効</span></div>";
        }
    </script>
</body>
</html>
